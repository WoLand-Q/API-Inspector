# API-Inspector

Веб-приложение, которое помогает разработчикам работать с **Syrve Cloud (iiko Cloud/Transport) API** и **Syrve Server (iikoServer) API** без Postman. Проект показывает готовые примеры запросов (авторизация, получение организаций и терминальных групп, выгрузка меню и адресов, создание доставки) и даёт каркас для быстрой интеграции в прод-сайт доставки.

> ⚠️ Эндпоинты и обязательные поля развиваются. Всегда сверяйтесь с официальной документацией по ссылкам в конце файла.

---

## Оглавление

- [Возможности](#возможности)
- [Архитектура и структура](#архитектура-и-структура)
- [Быстрый старт (локально)](#быстрый-старт-локально)
- [Конфигурация](#конфигурация)
- [Сценарий: меню → адреса → создание доставки](#сценарий-меню--адреса--создание-доставки)
- [Примеры запросов (cURL)](#примеры-запросов-curl)
- [Интеграция в прод-сайт доставки](#интеграция-в-прод-сайт-доставки)
- [Рекомендации для продакшена](#рекомендации-для-продакшена)
- [Ссылки на официальные доки](#ссылки-на-официальные-доки)
- [Лицензия](#лицензия)

---

## Возможности

- Авторизация в **Syrve Cloud** по `apiLogin` и работа с Bearer-токеном.
- Получение **организаций** и **терминальных групп**.
- Выгрузка **номенклатуры (меню)** с модификаторами — для кэширования на сайте.
- Работа с **адресным справочником** (города/улицы) для формы адреса.
- **Создание доставки** (курьер/самовывоз) с минимально-необходимым телом запроса.
- Примеры обращений к **Syrve Server API** (опционально).
- Логирование запросов/ответов и простой UI, чтобы «клик-клик → готов JSON».

---

## Архитектура и структура
~~~bash
API-Inspector/
├─ public/                        # веб-корень (UI + REST-эндпоинты)
│  ├─ assets/                     # JS/CSS фронтенда
│  ├─ partials/                   # формы/модалки: меню, адреса/доставка, лояльность, отчёты, сервер
│  ├─ api.php                     # маршруты для Cloud API
│  ├─ api.server.php              # маршруты для Server API
│  └─ index.php
├─ src/
│  ├─ SyrveClient.php             # клиент Cloud API
│  ├─ IikoServerClient.php        # клиент Server API
│  ├─ Http.php                    # HTTP-обёртка
│  ├─ Logger.php                  # логирование
│  ├─ DB.php                      # (опционально) хранилище
│  ├─ Config.php                  # конфигурация проекта (заполнить!)
│  └─ bootstrap.php               # инициализация
├─ LICENSE
└─ README.md
~~~



---

## Быстрый старт (локально)

**Требования**

- **PHP 8.x** (подойдёт 7.4+, но лучше актуальная версия).
- Доступ к **Syrve Cloud** (ваш `apiLogin`).

**Шаги**

~~~bash
git clone https://github.com/WoLand-Q/API-Inspector.git
cd API-Inspector

# запустить dev-сервер PHP (только локально!)
php -S 127.0.0.1:8080 -t public
~~~

Откройте: `http://127.0.0.1:8080/`

> Встроенный сервер PHP — только для разработки/демо. В продакшене используйте Nginx/Apache.

---

## Конфигурация

Откройте `src/Config.php` и заполните значения:

~~~php
<?php
return [
  'cloud' => [
    'baseUrl'  => 'https://api-eu.syrve.live',
    'apiLogin' => 'ВАШ_API_LOGIN',
  ],
  'server' => [
    'baseUrl'  => 'https://ВАШ-СЕРВЕР/resto/api',
    'login'    => 'user',
    'password' => 'pass',
  ],
];
~~~

---

## Сценарий: меню → адреса → создание доставки

1. **Токен Cloud**  
   Введите `apiLogin` в UI → получите `access_token` (далее используйте заголовок `Authorization: Bearer <token>`).

2. **Организация**  
   Запросите список организаций и выберите нужный `organizationId`.

3. **Терминальная группа**  
   Получите `terminalGroupId` — куда «полетит» заказ.

4. **Номенклатура (меню)**  
   Вытяните `nomenclature` и закешируйте в БД сайта (обновляйте по расписанию).

5. **Адреса (города/улицы)**  
   Подготовьте/синхронизируйте справочники. Форма адреса на сайте должна маппиться на поля Cloud API.

6. **Создать доставку**  
   Соберите валидный JSON: клиент, адрес (город/улица/дом/координаты), позиции/модификаторы, `sourceKey`, `organizationId`, `terminalGroupId`, тип (курьер/самовывоз), оплаты/комментарии → отправьте запрос создания доставки и обработайте статус.

**Частые ошибки**

- `401` — токен истёк/невалиден;
- `403` — `organizationId` не принадлежит вашему `apiLogin`;
- `400` — не прошла валидация тела (проверьте обязательные поля, например `isCourierDelivery` и т. п.).

---

## Примеры запросов (cURL)

> Эндпоинты версионируются — сверяйте с вашей актуальной схемой на портале Cloud API.

**1) Получить токен**

~~~bash
curl -X POST "https://api-eu.syrve.live/api/1/access_token" \
  -H "Content-Type: application/json" \
  -d '{"apiLogin":"<ВАШ_API_LOGIN>"}'
~~~

**2) Организации**

~~~bash
curl -X POST "https://api-eu.syrve.live/api/1/organizations" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <TOKEN>" \
  -d '{"returnAdditionalInfo": false}'
~~~

**3) Номенклатура (меню)**

~~~bash
curl -X POST "https://api-eu.syrve.live/api/1/nomenclature" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <TOKEN>" \
  -d '{"organizationId":"<ORG_UUID>"}'
~~~

**4) Города/улицы**  
Конкретные маршруты зависят от вашей конфигурации (см. разделы про Cities/Streets в базе знаний).

**5) Создание доставки (каркас)**  
Следуйте гайду «Delivery creation»: соберите заказ с позициями, адресом, `sourceKey`, `organizationId`, `terminalGroupId`, типом и оплатами — и отправьте на Cloud API. Обязательные поля и точный JSON смотрите в схеме.

---

## Интеграция в прод-сайт доставки

**Получить доступы**  
Подключите **External Orders** в кабинете Syrve, настройте **Order Source** (получите `sourceKey`), убедитесь, что нужные организации прикреплены к вашему `apiLogin`.

**Авторизация и хранение токена**  
Реализуйте получение `access_token` и его обновление. Храните токен на бэкенде (не в браузере).

**Кэш меню**  
Сервис-джобой обновляйте `nomenclature` (например, каждые N минут/часов). Держите удобные индексы по продуктам/модификаторам.

**Валидация адреса**  
Используйте справочники Syrve (или свой геосервис), но мапьте значения на поля Cloud API.

**Создание доставки**  
На сервере собирайте JSON заказа, проверяйте обязательные поля, логируйте ответы/ошибки. Не отправляйте запрос напрямую из браузера — только через ваш бэкенд.

**Статусы и ретраи**  
Обрабатывайте статусы заказа, таймауты, повторные попытки, идемпотентность (корреляционные ID).

---

## Рекомендации для продакшена

- **Безопасность:** не храните `apiLogin` и токены на клиенте; используйте HTTPS, rate-limits, валидацию входящих данных.
- **Надёжность:** логируйте корреляционные ID/ошибки, ставьте ретраи с backoff, мониторьте 4xx/5xx.
- **Производительность:** кешируйте меню и справочники, используйте сжатие и HTTP-пулы, не трогайте Cloud API по каждому клику.
- **Версионирование:** периодически сверяйте контракт со схемой Cloud API (могут добавляться поля/ограничения).

---

## Ссылки на официальные доки

- Обзор уровней API (Cloud/Live/Server/Loyalty):  
  https://en.syrve.help/articles/api/getting-started-api
- Портал **iiko Cloud / Transport API** (актуальные схемы):  
  https://api-ru.iiko.services
- Гайд **Delivery creation** (порядок действий):  
  https://en.syrve.help/articles/api/delivery-creation
- **Order Source / External Orders** (apiLogin, sourceKey):  
  https://en.syrve.help/articles/api/order-source-setup
- **Cities & Streets** (загрузка/синхронизация справочника):  
  https://en.syrve.help/articles/#!api/cities-and-streets-upload
- Общее про **Syrve Server (iikoServer) API**:  
  https://en.syrve.help/  _(разделы Integrations/API в Knowledge Base)_
- POS/Front SDK (если пишете плагин под кассу):  
  https://syrve.github.io/front.api.doc/v6/en/Intro.html

---

## Лицензия

Проект распространяется по лицензии **Apache-2.0**. См. файл `LICENSE`.
